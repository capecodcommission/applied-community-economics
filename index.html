<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>CCC ~ Community Characteristics</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.20/esri/css/esri.css">
	<script src="https://js.arcgis.com/3.20/"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    window.dojoConfig = {

      packages: [
        {
          name: 'vue',
          location: location.pathname.replace('/\/[^/]+$','') + "/node_modules/vue/dist",
          main: 'vue'
        }
      ]
    }
  </script>
  <script>
    // Load the Visualization API and the controls package.
    google.charts.load('current', 
      {
        'packages':['corechart', 'controls']
      }
    );

    // Set a callback to run when the Google Visualization API is loaded.
    google.charts.setOnLoadCallback(this.drawDashboard);


  </script>
	<script>
var map;
require([
  "esri/map", 
  "esri/layers/FeatureLayer", 
  "esri/InfoTemplate", 
  "esri/config", 
  "esri/tasks/query",
  "esri/graphicsUtils",
  "esri/tasks/StatisticDefinition",
  "dojo/domReady!"
], function(Map, FeatureLayer, InfoTemplate, Config, Query, graphicsUtils, StatisticDefinition) {

  map = new Map("map", {
    basemap: "streets-night-vector",
    center: [-70.31509, 41.68935],
    zoom: 11,
    logo: false
  });

  var embayTemplate = new InfoTemplate({
    title: "<b>${LOC_ID}</b>"
  })

  var embayments = new FeatureLayer("http://gis-services.capecodcommission.org/arcgis/rest/services/ActivityCenters/CommunityCharacteristics/MapServer/0", {
    mode: FeatureLayer.MODE_SELECTION,
    outFields: ['*'],
    opacity: 1,
    infoTemplate: embayTemplate
  })

  var embayments1 = new FeatureLayer("http://gis-services.capecodcommission.org/arcgis/rest/services/ActivityCenters/CommunityCharacteristics/MapServer/0", {
    mode: FeatureLayer.MODE_SELECTION,
    outFields: ['*'],
    opacity: 1,
    infoTemplate: embayTemplate
  })

  map.addLayer(embayments)
  map.addLayer(embayments1)

  var selectionSymbol = new esri.symbol.SimpleFillSymbol().setColor(new esri.Color([218,112,214,0.5]));
  embayments.setSelectionSymbol(selectionSymbol)

  var selectionSymbol1 = new esri.symbol.SimpleFillSymbol().setColor(new esri.Color([244, 128, 66]));
  embayments1.setSelectionSymbol(selectionSymbol1)

  embayTemplate.setContent('${*}')


  var comScore = 1
  var buScore = 1
  var formScore = 1

  var ctx = $("#myChart");

  var myChart = new Chart(ctx, {
    type: 'polarArea',
    data: {
      datasets: [{
        data: [comScore, buScore, formScore],
        backgroundColor: ['#4286f4', '#f4a941', '#6c6772']
      }],

  // These labels appear in the legend and in the tooltips when hovering different arcs
      labels: [
        'Community Score',
        'Business Score',
        'Form Score'
      ]
    },
    options: {
      scale: {
        ticks: {
          min: 0,
          max: 4,
          stepSize: 1
        }
      }
    }
  })

  // If EMBAY_ID from dropdown matches EMBAY_ID in feature layer, zoom to queried embayment's extent.
  ZoomToSelection = function(x) {

    embayments.clearSelection();
    embayments1.clearSelection()

    var query = new Query()
    query.where = "Neighborhood = " + "'" + x + "'" 
    query.outFields = ['*']

    var query1 = new Query()
    query1.where = "Neighborhood = " + "'" + x + "'" + " and PctImp_Above40 = 1 and FormWeight >= 6"
    query1.outFields = ['*']


    embayments.selectFeatures(query, FeatureLayer.SELECTION_NEW, function (features) {

      var extent = graphicsUtils.graphicsExtent(features)

      map.setExtent(extent.expand(1.2), true)

      var sumBA = 0
      var sumCA = 0
      var sumabv40 = 0 
      var sumForm = 0
      var pctGF = 0

      for (var i = features.length - 1; i >= 0; i--) {

        sumBA += features[i].attributes.SUM_BAsites
        sumCA += features[i].attributes.SUM_CAsites
        sumabv40 += features[i].attributes.PctImp_Above40

        if (features[i].attributes.FormWeight >= 6 && features[i].attributes.PctImp_Above40 === 1) {

          sumForm += 1
        }
      }

      if (sumCA > 9) {

        comScore = 4
      } else if (sumCA > 6) {

        comScore = 3
      } else if (sumCA > 2) {

        comScore = 2
      } else if (sumCA >= 1) {

        comScore = 1
      } else {

        comScore = 0
      }

      if (sumBA > 98) {

        buScore = 4
      } else if (sumBA > 34) {

        buScore = 3
      } else if (sumBA > 10) {

        buScore = 2
      } else if (sumBA > 10) {

        buScore = 1
      } else {

        buScore = 0
      }

      pctG = sumForm / sumabv40

      if (pctG > .6) {

        formScore = 4
      } else if (pctG > .4) {

        formScore = 3
      } else if (pctG > .2) {

        formScore = 2
      } else if (pctG > .01) {

        formScore = 1
      } else {

        formScore = 0
      }

      myChart.data.datasets[0].data = [comScore, buScore, formScore]
      myChart.update()

      pctGF = Math.round((sumForm / sumabv40) * 100).toString() + "%"

      $('#BAsites').text(sumBA)
      $('#CAsites').text(sumCA)
      $('#abv_40').text(sumabv40)
      $('#frmWt').text(sumForm)
      $('#pct_GF').text(pctGF)

    embayments1.selectFeatures(query1, FeatureLayer.SELECTION_ADD, function (features) {})
    })
  }

  ZoomToSelection1 = function(x) {

    embayments.clearSelection();
    embayments1.clearSelection();

    var query = new Query()
    query.where = "AC_FINAL = " + "'" + x + "'" 
    query.outFields = ['*']

    var query1 = new Query()
    query1.where = "AC_FINAL = " + "'" + x + "'" + " and PctImp_Above40 = 1 and FormWeight >= 6"
    query1.outFields = ['*']


    embayments.selectFeatures(query, FeatureLayer.SELECTION_NEW, function (features) {

      var extent = graphicsUtils.graphicsExtent(features)

      map.setExtent(extent.expand(1.2), true)

      var sumBA = 0
      var sumCA = 0
      var sumabv40 = 0 
      var sumForm = 0
      var pctGF = 0

      for (var i = features.length - 1; i >= 0; i--) {

        sumBA += features[i].attributes.SUM_BAsites
        sumCA += features[i].attributes.SUM_CAsites
        sumabv40 += features[i].attributes.PctImp_Above40

        if (features[i].attributes.FormWeight >= 6 && features[i].attributes.PctImp_Above40 === 1) {

          sumForm += 1
        }
      }

      if (sumCA > 9) {

        comScore = 4
      } else if (sumCA > 6) {

        comScore = 3
      } else if (sumCA > 2) {

        comScore = 2
      } else if (sumCA >= 1) {

        comScore = 1
      } else {

        comScore = 0
      }

      if (sumBA > 98) {

        buScore = 4
      } else if (sumBA > 34) {

        buScore = 3
      } else if (sumBA > 10) {

        buScore = 2
      } else if (sumBA > 10) {

        buScore = 1
      } else {

        buScore = 0
      }

      pctG = sumForm / sumabv40

      if (pctG > .6) {

        formScore = 4
      } else if (pctG > .4) {

        formScore = 3
      } else if (pctG > .2) {

        formScore = 2
      } else if (pctG > .01) {

        formScore = 1
      } else {

        formScore = 0
      }

      myChart.data.datasets[0].data = [comScore, buScore, formScore]
      myChart.update()

      pctGF = Math.round((sumForm / sumabv40) * 100).toString() + "%"

      $('#BAsites').text(sumBA)
      $('#CAsites').text(sumCA)
      $('#abv_40').text(sumabv40)
      $('#frmWt').text(sumForm)
      $('#pct_GF').text(pctGF)

    embayments1.selectFeatures(query1, FeatureLayer.SELECTION_ADD, function (features) {})
    })
  }

  ZoomToSelection2 = function(x) {

    embayments.clearSelection();
    embayments1.clearSelection();

    var query = new Query()
    query.where = "Town = " + "'" + x + "'" 
    query.outFields = ['*']

    var query1 = new Query()
    query1.where = "Town = " + "'" + x + "'" + " and PctImp_Above40 = 1 and FormWeight >= 6"
    query1.outFields = ['*']


    embayments.selectFeatures(query, FeatureLayer.SELECTION_NEW, function (features) {

      var extent = graphicsUtils.graphicsExtent(features)

      map.setExtent(extent.expand(1.2), true)

      var sumBA = 0
      var sumCA = 0
      var sumabv40 = 0 
      var sumForm = 0
      var pctGF = 0

      for (var i = features.length - 1; i >= 0; i--) {

        sumBA += features[i].attributes.SUM_BAsites
        sumCA += features[i].attributes.SUM_CAsites
        sumabv40 += features[i].attributes.PctImp_Above40

        if (features[i].attributes.FormWeight >= 6 && features[i].attributes.PctImp_Above40 === 1) {

          sumForm += 1
        }
      }

      if (sumCA > 9) {

        comScore = 4
      } else if (sumCA > 6) {

        comScore = 3
      } else if (sumCA > 2) {

        comScore = 2
      } else if (sumCA >= 1) {

        comScore = 1
      } else {

        comScore = 0
      }

      if (sumBA > 98) {

        buScore = 4
      } else if (sumBA > 34) {

        buScore = 3
      } else if (sumBA > 10) {

        buScore = 2
      } else if (sumBA > 10) {

        buScore = 1
      } else {

        buScore = 0
      }

      pctG = sumForm / sumabv40

      if (pctG > .6) {

        formScore = 4
      } else if (pctG > .4) {

        formScore = 3
      } else if (pctG > .2) {

        formScore = 2
      } else if (pctG > .01) {

        formScore = 1
      } else {

        formScore = 0
      }

      myChart.data.datasets[0].data = [comScore, buScore, formScore]
      myChart.update()

      pctGF = Math.round((sumForm / sumabv40) * 100).toString() + "%"

      $('#BAsites').text(sumBA)
      $('#CAsites').text(sumCA)
      $('#abv_40').text(sumabv40)
      $('#frmWt').text(sumForm)
      $('#pct_GF').text(pctGF)

    embayments1.selectFeatures(query1, FeatureLayer.SELECTION_ADD, function (features) {})
    })
  }


  // On new dropdown selection, pass EMBAY_DISP to ZoomToSelection 
  $('#neighborhoodSelect').on('change', function() {

    var x = $(this).val().toString()

    if (x === '0') {

      embayments.clearSelection();
      map.setExtent(embayments.fullExtent.getExtent(), true)
    } else {

      ZoomToSelection(x)
      $('#acSelect').val('0')
      $('#townSelect').val('0')
    }
  })

  $('#acSelect').on('change', function() {

    var x = $(this).val().toString()

    if (x === '0') {

      embayments.clearSelection();
      map.setExtent(embayments.fullExtent.getExtent(), true)
    } else {

      ZoomToSelection1(x)
      $('#neighborhoodSelect').val('0')
      $('#townSelect').val('0')
    }
  })

  $('#townSelect').on('change', function() {

    var x = $(this).val().toString()

    if (x === '0') {

      embayments.clearSelection();
      map.setExtent(embayments.fullExtent.getExtent(), true)
    } else {

      ZoomToSelection2(x)
      $('#neighborhoodSelect').val('0')
      $('#acSelect').val('0')
    }
  })
});
	</script>
  </head>
  <body>
    <div id="app">
      <app></app>
    </div>
  </body>
</html>
